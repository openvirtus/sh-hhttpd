#!/bin/sh -e
#L:
#l:  Copyright (c) 2018 Openvirtus.com, http://openvirtus.com
#L:
#L:  Permission is hereby granted, free of charge, to any person obtaining
#L:  a copy of this software and associated documentation files (the
#L:  "Software"), to deal in the Software without restriction, including
#L:  without limitation the rights to use, copy, modify, merge, publish,
#L:  distribute, sublicense, and/or sell copies of the Software, and to
#L:  permit persons to whom the Software is furnished to do so, subject to
#L:  the following conditions:
#L:
#L:  The above copyright notice and this permission notice shall be
#L:  included in all copies or substantial portions of the Software.
#L:
#L:  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
#L:  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
#L:  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
#L:  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
#L:  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
#L:  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
#L:  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#L:
#h: Usage: $0 [OPTIONS...] [-b] DIRECTORY [PORT]
#h:
#h: This script helps launching different HTTP servers. This is usefull to
#h: test web apps.
#h:
#h:    -v            : Show configuation.
#h:    -s php        : Use PHP to service the directory.
#h:    -s artisan    : Use artisan to serve Laravel website.
#h:    -s mini_httpd : Use `mini_httpd` to serve site.
#h:    -i composer   : Install composer, required to build PHP sites.
#h:    -b            : Build (composer: composer.json).
#h:
#h:    -d DOMAIN     : Domain to serve.
#h:    -S            : Enable TLS/SSL.
#h:
#h: Examples:
#h:
#h:    > httpd -s mini_httpd -d harkadev.com -S . 441
hhttpd() {
    ## Parse command line arguments.
    local OPTIND optopt= ops= installs= i=
    while getopts "vs:i:bd:S" optopt;do # OPTARG
        local ops="${ops}${optopt}"
        case $optopt in
            s)  HHTTPD_SELECT="${OPTARG}" ;;
            d)  HHTTPD_DOMAIN="${OPTARG}" ;;
            S)  HHTTPD_ENABLE_SSL=y       ;;
            i)  local installs="${installs} ${OPTARG}";;
            \?) return 1;;
        esac
    done
    shift $(( $OPTIND - 1 ))
    ## Flagged operations.
    case "${ops}" in *v*) hhttpd_show_variables;; esac
    case "${ops}" in *i*) for i in ${installs};do hhttpd_install_"${i}";done;; esac
    ## Service directory.
    local directory="${1}"
    case "${ops}" in *b*) hhttpd_build "${directory:-`pwd`}";; esac
    
    if test -n "${directory}";then
        if test -n "${2}";then
            local HHTTPD_PORT="${2}"
        fi
        if test ! -d "${directory}";then
            echo "hhttpd: error: The directory ${directory} does not exist." >&2
            exit 1
        fi
        
        hhttpd_execute_"${HHTTPD_SELECT}" "${directory}"
    fi
    
}
hhttpd_show_variables() {
    printf '%-20s : %s\n' HHTTPD_SELECT     "${HHTTPD_SELECT}"
    printf '%-20s : %s\n' HHTTPD_PORT       "${HHTTPD_PORT}"
    printf '%-20s : %s\n' HHTTPD_DOMAIN     "${HHTTPD_DOMAIN}"
    printf '%-20s : %s\n' HHTTPD_ENABLE_SSL "${HHTTPD_ENABLE_SSL}"
    printf '%-20s : %s\n' HSSL_ETCDIR       "${HSSL_ETCDIR}"
}
hhttpd_calc_variables() {
    HHTTPD_SELECT="${HHTTPD_SELECT:-php}"
    HHTTPD_PORT="${HHTTPD_PORT:-8081}"
    HHTTPD_DOMAIN="${HHTTPD_DOMAIN:-`hostname`}"
    HHTTPD_ENABLE_SSL="${HHTTPD_ENABLE_SSL:-n}"
    HSSL_ETCDIR="${HSSL_ETCDIR:-/etc/ssl}"
}
## -----------------------------------------------------------------------
hhttpd_execute_php() { # DIR
    echo "Serving by php ..."
    local directory="${1}"
    if test -d "${directory}/public";then
        local directory="${directory}/public"
    elif test -d "${directory}/upload";then
        local directory="${directory}/upload"
    fi
    php -S "localhost:${HHTTPD_PORT}" -t "${directory}"
}
hhttpd_execute_artisan() { # DIR
    echo "Serving by artisan ..."
    cd "${1}"
    SERVER_PORT="${HHTTPD_PORT}" php artisan serve
}
hhttpd_execute_mini_httpd() { # DIR
    local args=
    if test @"${HHTTPD_ENABLE_SSL}" = @"y";then
        local args="${args} -S"
        if test -f "${HSSL_ETCDIR}/${HHTTPD_DOMAIN}.cert";then
            local args="${args} -E ${HSSL_ETCDIR}/${HHTTPD_DOMAIN}.cert"
        else
            echo "error: File ${HSSL_ETCDIR}/${HHTTPD_DOMAIN}.cert does not exist." >&2
            exit 1
        fi
    fi
    vrun /usr/sbin/mini_httpd               \
         -D `: Foreground`                  \
         -h 127.0.0.1                       \
         -p "${HHTTPD_PORT}"                \
         -c "**.cgi"                        \
         -u "${USER}" `: Default is nobody` \
         -d "${directory}"                  \
         ${args}
}




hhttpd_install_composer() {
    if which composer >/dev/null 2>&1;then
        true
    elif which xbps-install >/dev/null 2>&1;then
        sudo xbps-install -S -y "composer"
    fi
}
hhttpd_build() {
    local directory="$1" workdir="`pwd`"
    cd "${directory}"
    if test -f composer.json;then
        # composer require barryvdh/laravel-debugbar
        composer install --no-dev
    else
        echo "hhttpd: error: Do not know how to build directory." >&2
        exit 1
    fi
    cd "${workdir}"
}
vrun() {
    echo "$*" >&2
    "$@"
}



## -----------------------------------------------------------------------
hhttpd_calc_variables
if test @"`basename "$0"`" = @"hhttpd";then
    if test -n "$1";then
        hhttpd "$@"
    else
        sed -n 's/^ *#h: \{0,1\}//p' "$0" | sed "s|\\\$0|`basename $0`|g"
        echo ""
        sed -n 's/^ *#l: \{0,2\}//p' "$0"
    fi
fi
